{% extends "layout.html" %}

{% block title %}Scadenzario{% endblock %}

{% block scripts %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'it',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: '/api/scadenze',
                eventClick: function(info) {
                    if (info.event.url) {
                        window.location.href = info.event.url;
                        info.jsEvent.preventDefault();
                    }
                }
            });
            calendar.render();
        });
    </script>
{% endblock %}

{% block content %}
<div class="panel full-width">
    <div class="panel-header">
        <h2>Aggiungi Nuova Scadenza</h2>
    </div>

    <form action="{{ url_for('add_scadenza') }}" method="post" class="compact-form">
        <div class="form-group flex-grow">
            <label for="descrizione">Descrizione</label>
            <input type="text" name="descrizione" id="descrizione" required>
        </div>
        <div class="form-group">
            <label for="data_scadenza">Data</label>
            <input type="date" name="data_scadenza" id="data_scadenza" required>
        </div>
        <!-- NUOVO CAMPO IMPORTO -->
        <div class="form-group">
            <label for="importo_scadenza">Importo Rata (Opzionale)</label>
            <input type="text" name="importo_scadenza" id="importo_scadenza" placeholder="Es. 500.00">
        </div>
        <div class="form-group">
            <label for="spesa_associata_id">Spesa Associata</label>
            <select name="spesa_associata_id" id="spesa_associata_id">
                <option value="">Nessuna</option>
                {% for spesa in spese_disponibili %}
                <option value="{{ spesa.id }}">{{ spesa.descrizione }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">Aggiungi</button>
    </form>

    <hr class="section-divider">
    <div id="calendar"></div>
    <hr class="section-divider">

    <div class="panel-header">
        <h2>Elenco Completo</h2>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Descrizione</th>
                    <th>Data Scadenza</th>
                    <th>Importo Rata</th> <!-- NUOVA COLONNA -->
                    <th>Stato</th>
                    <th class="actions-column">Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for scadenza in scadenze %}
                <tr>
                    <td>
                        {% if scadenza.spesa_associata_id %}
                            <a href="{{ url_for('edit_spesa', id=scadenza.spesa_associata_id) }}">{{ scadenza.descrizione }}</a>
                        {% else %}
                            {{ scadenza.descrizione }}
                        {% endif %}
                    </td>
                    <td>{{ scadenza.data_scadenza }}</td>
                    <td>
                        {% if scadenza.importo_scadenza %}
                            € {{ "%.2f"|format(scadenza.importo_scadenza) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ scadenza.stato }}</td>
                    <td class="actions-column">
                        <a href="{{ url_for('toggle_scadenza', id=scadenza.id) }}" class="edit-btn" title="Cambia Stato">✓</a>
                        <a href="{{ url_for('delete_scadenza', id=scadenza.id) }}" class="delete-btn" title="Elimina">X</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}