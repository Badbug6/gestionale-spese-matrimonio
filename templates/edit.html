{% extends "layout.html" %}
{% block title %}Gestione Spesa{% endblock %}
{% block content %}

<!-- Utilizziamo un unico pannello a larghezza intera per contenere tutto -->
<div class="panel full-width">

    <div class="panel-header">
        <h2>Gestione Spesa: {{ spesa.descrizione }}</h2>
        <a href="{{ url_for('index') }}" class="button-link">Torna alla Dashboard</a>
    </div>

    <!-- Sezione 1: Modifica Dettagli Principali -->
    <form method="post" action="{{ url_for('edit_spesa', id=spesa.id) }}" class="compact-form">
        <div class="form-group flex-grow"><label for="descrizione">Descrizione</label><input type="text" name="descrizione" id="descrizione" value="{{ spesa.descrizione }}" required></div>
        <div class="form-group"><label for="importo">Importo Previsto</label><input type="text" name="importo" id="importo" value="{{ spesa.importo }}" required></div>
        <div class="form-group">
            <label for="categoria">Categoria</label>
            <select name="categoria" id="categoria" required>
                {% for category in categories %}<option value="{{ category }}" {% if category == spesa.categoria %}selected{% endif %}>{{ category }}</option>{% endfor %}
            </select>
        </div>
        <button type="submit">Salva Dettagli</button>
    </form>

    <hr class="section-divider">

    <!-- Sezione 2: Riepilogo Finanziario -->
    <div class="summary-cards">
        <div class="card"><h3>Costo Previsto</h3><p>€ {{ "%.2f"|format(spesa.importo) }}</p></div>
        <div class="card"><h3>Totale Pagato</h3><p>€ {{ "%.2f"|format(totale_pagato) }}</p></div>
        <div class="card remaining"><h3>Residuo da Pagare</h3><p>€ {{ "%.2f"|format(rimanente_da_pagare) }}</p></div>
    </div>

    <hr class="section-divider">

    <!-- Sezione 3: Aggiunta Pagamenti e Storico -->
    <div class="panel-header">
        <h4>Gestione Pagamenti</h4>
    </div>
    <form action="{{ url_for('add_pagamento', spesa_id=spesa.id) }}" method="post" class="compact-form">
        <div class="form-group flex-grow"><label for="note">Note</label><input type="text" name="note" id="note" placeholder="Es. Acconto"></div>
        <div class="form-group"><label for="importo_pagato">Importo</label><input type="text" name="importo_pagato" id="importo_pagato" placeholder="Es. 500.00" required></div>
        <div class="form-group"><label for="data_pagamento">Data</label><input type="date" name="data_pagamento" id="data_pagamento" required></div>
        <button type="submit">Aggiungi Pagamento</button>
    </form>
    <div class="table-container" style="margin-top: 1.5rem;">
        <table>
            <thead><tr><th>Data</th><th>Importo</th><th>Note</th><th class="actions-column">Azioni</th></tr></thead>
            <tbody>
                {% for p in pagamenti %}
                <tr>
                    <td>{{ p.data_pagamento }}</td>
                    <td>€ {{ "%.2f"|format(p.importo_pagato) }}</td>
                    <td>{{ p.note or '-' }}</td>
                    <td class="actions-column">
                        <form action="{{ url_for('delete_pagamento', pagamento_id=p.id) }}" method="post" onsubmit="return confirm('Sei sicuro?');"><button type="submit" class="delete-btn">Elimina</button></form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="4" style="text-align: center; padding: 1.5rem 0;">Nessun pagamento registrato.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <hr class="section-divider">

    <!-- Sezione 4: Aggiunta Allegati e Storico -->
    <div class="panel-header">
        <h4>Gestione Allegati</h4>
    </div>
    <form action="{{ url_for('upload_file', spesa_id=spesa.id) }}" method="post" enctype="multipart/form-data" class="compact-form">
        <div class="form-group flex-grow">
            <label for="file">Seleziona Contratto/Ricevuta</label>
            <input type="file" name="file" id="file" class="input-file" required>
        </div>
        <button type="submit">Carica File</button>
    </form>
    <div class="table-container" style="margin-top: 1.5rem;">
        <table>
            <thead><tr><th>Nome File</th><th class="actions-column">Azioni</th></tr></thead>
            <tbody>
                {% for allegato in allegati %}
                <tr>
                    <td><a href="{{ url_for('serve_uploaded_file', filename=allegato.saved_filename) }}" target="_blank">{{ allegato.original_filename }}</a></td>
                    <td class="actions-column">
                        <form action="{{ url_for('delete_allegato', allegato_id=allegato.id) }}" method="post" onsubmit="return confirm('Sei sicuro?');"><button type="submit" class="delete-btn">Elimina</button></form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="2" style="text-align: center; padding: 1.5rem 0;">Nessun allegato presente.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}